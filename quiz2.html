<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Decoder Challenge - Chapter 2</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Changed font to Inter */
            background-color: #f0f0f0; /* Light gray background */
            color: #333; /* Dark gray text */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 20px 60px 20px;
            box-sizing: border-box;
            position: relative;
        }

        #game-container, #review-container {
            background-color: #ffffff; /* White background for containers */
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            width: 95%;
            max-width: 700px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0; /* Light border */
        }

        h1 {
            color: #222; /* Darker title */
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 700;
        }
        h2 {
            color: #444; /* Slightly lighter heading */
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }

        #progress-area {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 500;
            color: #555;
        }
        
        #current-score {
            font-size: 1.3em;
            font-weight: 600;
            color: #000; /* Black for score */
            margin-bottom: 25px;
        }
        #current-score.negative {
            color: #d9534f; /* Red for negative score */
        }

        #question-area {
            margin-bottom: 25px;
            padding: 25px;
            border: 1px solid #ccc; /* Gray border */
            border-radius: 8px;
            background-color: #fdfdfd; /* Off-white for question area */
            min-height: 120px;
            text-align: left;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        #question-text {
            font-size: 1.2em;
            margin-bottom: 15px;
            line-height: 1.6;
            color: #333;
        }

        .mcq-options button {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background-color: #eee; /* Light gray button */
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.2s;
            font-weight: 500;
        }

        .mcq-options button:hover {
            background-color: #ddd; /* Darker gray on hover */
            transform: translateY(-2px);
            border-color: #999;
        }
        .mcq-options button:disabled {
            background-color: #e0e0e0;
            color: #888;
            cursor: not-allowed;
            border-color: #ddd;
        }
        .mcq-options button.correct-selection {
            background-color: #d4edda !important; /* Light green for correct */
            border-color: #28a745 !important; /* Green border */
            color: #155724 !important;
            font-weight: 600;
        }
        .mcq-options button.incorrect-selection {
            background-color: #f8d7da !important; /* Light red for incorrect */
            border-color: #dc3545 !important; /* Red border */
            color: #721c24 !important;
            font-weight: 600;
        }


        #answer-input, #short-answer-input {
            width: calc(100% - 30px); /* Adjust for padding and border */
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1.05em;
            background-color: #fdfdfd;
            color: #333;
        }
         #short-answer-input {
            min-height: 100px;
            resize: vertical;
        }

        #submit-button, #next-button, #confirm-assessment-button, #play-again-button, #back-to-start-button {
            background-color: #333; /* Dark gray for primary actions */
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-top: 15px;
            margin-right: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #submit-button:hover, #next-button:hover, #confirm-assessment-button:hover, #play-again-button:hover {
            background-color: #000; /* Black on hover */
            transform: translateY(-2px);
        }
        #next-button {
            background-color: #555; /* Slightly lighter for next */
        }
        #next-button:hover {
            background-color: #333;
        }
        #back-to-start-button {
            background-color: #999; /* Medium gray for back button */
        }
        #back-to-start-button:hover {
            background-color: #777;
        }


        #feedback-area {
            margin-top: 25px;
            font-size: 1.1em;
            font-weight: bold;
            min-height: 40px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid transparent; /* Default transparent border */
        }
        
        .correct-feedback {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .incorrect-feedback {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .info-feedback {
            color: #004085;
            background-color: #cce5ff;
            border-color: #b8daff;
        }

        .model-answer-container, .marking-scheme-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f8f8; /* Light gray for model answers */
            border-radius: 8px;
            text-align: left;
            font-size: 0.95em;
            border: 1px solid #e0e0e0;
        }
        .model-answer-container strong, .marking-scheme-container strong {
            color: #444;
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .marking-scheme-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .marking-scheme-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.3); /* Slightly larger checkbox */
            accent-color: #333; /* Black checkbox */
        }

        /* Review Screen Styles */
        #review-container {
            display: none;
            text-align: left;
        }
        #review-summary p {
            font-size: 1.1em;
            margin: 8px 0;
            color: #333;
        }
        /* CTA Button (top right) */
        .cta-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            background: #4f46e5;
            color: #fff;
            padding: 0.7rem 1.4rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            box-shadow: 0 4px 12px rgba(79,70,229,0.08);
            transition: background 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .cta-button:hover {
            background: #4338ca;
            transform: translateY(-2px) scale(1.03);
        }

        /* Copyright (bottom left) */
        .copyright-affirmation {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            z-index: 40;
            color: #6b7280;
            font-size: 0.98rem;
            background: rgba(255,255,255,0.85);
            padding: 0.4rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            font-family: inherit;
        }
        .review-tabs {
            margin-bottom: 25px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
        }
        .review-tabs button {
            padding: 10px 20px;
            margin: 0 5px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 1em;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            font-weight: 500;
        }
        .review-tabs button:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        .review-tabs button.active {
            background-color: #333;
            color: white;
            border-color: #333;
            border-bottom: 2px solid #333; /* Emphasize active tab */
            font-weight: 600;
        }

        .review-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }
        .review-table th, .review-table td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
            vertical-align: top;
        }
        .review-table th {
            background-color: #333;
            color: white;
            font-weight: bold;
        }
        .review-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .review-question-text { font-weight: 600; margin-bottom: 5px; color: #333;}
        .review-user-answer { color: #555; }
        .review-correct-answer { color: #28a745; font-weight: 500;}
        .review-score { font-weight: bold; color: #000;}
        .review-marking-scheme li { list-style-type: disc; margin-left: 20px; margin-bottom: 5px;}

        code {
            background-color: #e9ecef;
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            color: #c7254e; /* Code text color */
        }
        .question-marks-info {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .citation {
            font-style: italic;
            color: #888;
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
        }
        #copyright {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85em;
            color: #888;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <button class="cta-button" onclick="window.location.href='index.html'">Back to home</button>
    <div id="game-container">
        <h1>Digital Decoder Challenge - Chapter 2</h1>
        <div id="progress-area">Target Score: 15 points</div>
        <div id="current-score">Current Score: 0</div>
        
        <div id="question-area">
            <p id="question-text"></p>
            <p id="question-marks-info"></p>
            <div id="mcq-options" class="mcq-options"></div>
            <input type="text" id="answer-input" style="display:none;">
            <textarea id="short-answer-input" rows="4" style="display:none;"></textarea>
            <div id="marking-scheme-container" class="marking-scheme-container" style="display:none;">
                <strong>Marking Scheme (Self-Assess):</strong>
                <div id="marking-scheme-options"></div>
            </div>
        </div>

        <button id="submit-button" style="display:none;">Submit Answer</button>
        <button id="confirm-assessment-button" style="display:none;">Confirm Self-Assessment</button>
        <button id="next-button" style="display:none;">Next Question</button>

        <div id="feedback-area"></div>
        <div id="model-answer-container" class="model-answer-container" style="display:none;">
            <strong>Model Answer / Explanation:</strong>
            <p id="model-answer-text"></p>
        </div>
    </div>

    <div id="review-container">
        <h2>Challenge Review</h2>
        <div id="review-summary">
            <p id="final-score-review"></p>
            <p id="questions-answered-review"></p>
            <p id="questions-wrong-review"></p>
        </div>
        <div class="review-tabs">
            <button id="tab-all" class="active">All Questions</button>
            <button id="tab-correct">Correct Answers</button>
            <button id="tab-wrong">Wrong Answers</button>
        </div>
        <table class="review-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Question</th>
                    <th>Your Answer</th>
                    <th>Correct Answer / Scheme</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="review-table-body"></tbody>
        </table>
        <button id="play-again-button">Play Again</button>
        <button id="back-to-start-button">Back to Home</button>
    </div>
    <div id="copyright">Copyright &copy; Nachiketh Reddy</div>

    <script>
        const TARGET_SCORE = 15;
        const questions = [
            // --- Original MCQs ---
            {
                type: "mcq",
                text: "Which character encoding scheme was developed to support a wider range of characters from different languages, overcoming the limitations of ASCII? [cite: 4]",
                options: [
                    { text: "EBCDIC", correct: false },
                    { text: "Hexadecimal", correct: false },
                    { text: "Unicode", correct: true },
                    { text: "Baudot code", correct: false }
                ],
                explanation: "Unicode was created to represent characters from various languages, unlike ASCII which is limited, mostly to English. [cite: 4]"
            },
            {
                type: "mcq",
                text: "Why is hexadecimal often preferred over binary for representing data in computing? [cite: 16]",
                options: [
                    { text: "It can represent a larger range of numbers.", correct: false },
                    { text: "It's easier for computers to process.", correct: false },
                    { text: "It's a more compact and human-readable way to represent binary.", correct: true },
                    { text: "It inherently includes error checking.", correct: false }
                ],
                explanation: "Hexadecimal is used as a shorthand for binary because it's more compact and easier for humans to read and write long strings of bits. [cite: 16]"
            },
            {
                type: "mcq",
                text: "What is the range of unsigned numbers that can be represented with 4 bits? [cite: 15]",
                options: [
                    { text: "0 to 7", correct: false },
                    { text: "0 to 8", correct: false },
                    { text: "0 to 15", correct: true },
                    { text: "0 to 16", correct: false }
                ],
                explanation: "For N bits, the range of unsigned numbers is $0 \\text{ to } 2^N-1$. For 4 bits (N=4), this is $0 \\text{ to } 2^4-1 = 0 \\text{ to } 16-1 = 0 \\text{ to } 15$. [cite: 15]"
            },
            {
                type: "mcq",
                text: "In 2's complement representation, how is the sign of a number typically indicated? [cite: 24]",
                options: [
                    { text: "The rightmost bit (LSB).", correct: false },
                    { text: "The leftmost bit (MSB).", correct: true },
                    { text: "A separate sign flag.", correct: false },
                    { text: "The number of '1's in the binary string.", correct: false }
                ],
                explanation: "For signed integers in 2's complement, the leftmost bit (Most Significant Bit) is used to indicate the sign: 0 for positive, 1 for negative. [cite: 24]"
            },
            // --- New MCQs (Outside slides) ---
            {
                type: "mcq",
                text: "What is the primary function of a CPU's Arithmetic Logic Unit (ALU)?",
                options: [
                    { text: "Storing data temporarily", correct: false },
                    { text: "Performing arithmetic and logical operations", correct: true },
                    { text: "Managing input/output devices", correct: false },
                    { text: "Executing program instructions sequentially", correct: false }
                ],
                explanation: "The ALU is a fundamental part of the CPU responsible for all arithmetic (addition, subtraction, etc.) and logical (AND, OR, NOT) operations."
            },
            {
                type: "mcq",
                text: "Which of the following is a volatile memory type?",
                options: [
                    { text: "Hard Disk Drive (HDD)", correct: false },
                    { text: "Solid State Drive (SSD)", correct: false },
                    { text: "Random Access Memory (RAM)", correct: true },
                    { text: "Read-Only Memory (ROM)", correct: false }
                ],
                explanation: "Volatile memory loses its contents when power is turned off. RAM is a primary example, whereas HDDs, SSDs, and ROM are non-volatile."
            },
            {
                type: "mcq",
                text: "What does 'HTTP' stand for in the context of web browsing?",
                options: [
                    { text: "HyperText Transfer Protocol", correct: true },
                    { text: "High-Tech Transfer Program", correct: false },
                    { text: "Hyperlink Texting Protocol", correct: false },
                    { text: "Home Tool Transfer Process", correct: false }
                ],
                explanation: "HTTP (HyperText Transfer Protocol) is the foundation of data communication for the World Wide Web, defining how messages are formatted and transmitted."
            },
            {
                type: "mcq",
                text: "Which component of a computer system is responsible for converting digital signals to analog signals for display on a monitor?",
                options: [
                    { text: "Network Interface Card (NIC)", correct: false },
                    { text: "Sound Card", correct: false },
                    { text: "Graphics Processing Unit (GPU)", correct: true },
                    { text: "Central Processing Unit (CPU)", correct: false }
                ],
                explanation: "The GPU (Graphics Processing Unit) is specifically designed to render images, animations, and video for the computer's display. It converts digital data into a format that can be displayed on a monitor."
            },
            // --- Original Calculations (Treated like MCQs for scoring: +1 / -2) ---
            {
                type: "calculation",
                text: "Convert the binary number `101101` to decimal. [cite: 11, 13]",
                answer: "45",
                explanation: "To convert `101101` (binary) to decimal: \n(1 * 2^5) + (0 * 2^4) + (1 * 2^3) + (1 * 2^2) + (0 * 2^1) + (1 * 2^0)\n= (1 * 32) + (0 * 16) + (1 * 8) + (1 * 4) + (0 * 2) + (1 * 1)\n= 32 + 0 + 8 + 4 + 0 + 1 = 45. [cite: 11, 13]"
            },
            {
                type: "calculation",
                text: "What is the 8-bit 2's complement representation of the decimal number `-25`? [cite: 27]",
                answer: "11100111",
                explanation: "To find the 8-bit 2's complement of -25:\n1. Positive 25 in 8-bit binary: `00011001`.\n2. Invert the bits (1's complement): `11100110`.\n3. Add 1: `11100111`. [cite: 27]"
            },
            {
                type: "calculation",
                text: "Convert the hexadecimal number `A7` to an 8-bit binary number. [cite: 19, 20]",
                answer: "10100111",
                explanation: "To convert Hex `A7` to binary: \nConvert `A` (decimal 10) to 4-bit binary: `1010`. \nConvert `7` to 4-bit binary: `0111`. \nCombine them: `10100111`. [cite: 19, 20]"
            },
            // --- New Calculations (Outside slides) ---
            {
                type: "calculation",
                text: "Convert the decimal number `78` to its binary equivalent.",
                answer: "1001110",
                explanation: "Using repeated division by 2:\n78 / 2 = 39 R 0\n39 / 2 = 19 R 1\n19 / 2 = 9 R 1\n9 / 2 = 4 R 1\n4 / 2 = 2 R 0\n2 / 2 = 1 R 0\n1 / 2 = 0 R 1\nReading remainders from bottom up: `1001110`."
            },
            {
                type: "calculation",
                text: "Convert the binary number `110110` to hexadecimal.",
                answer: "36",
                explanation: "Pad with leading zeros to make groups of 4 bits: `0011 0110`.\nConvert each group to hexadecimal:\n`0011` = 3\n`0110` = 6\nCombine: `36` (hexadecimal)."
            },
            {
                type: "calculation",
                text: "What is the result of adding the 4-bit binary numbers `0101` (decimal 5) and `0011` (decimal 3)?",
                answer: "1000",
                explanation: "0101\n+0011\n-----\n1000 (decimal 8). No overflow occurs as the result is within the 4-bit signed range (-8 to +7) and the sign is correct."
            },
            // --- Original Short Answers (Self-Assessed) ---
            {
                type: "short-answer",
                text: "Briefly explain one scenario where overflow can occur when adding two 4-bit signed numbers in 2's complement representation. Provide an example. (Range for 4-bit signed: -8 to +7) [cite: 36, 37]",
                marksAwardable: 3, 
                modelAnswer: "Overflow occurs if adding two positive numbers results in a negative number, OR adding two negative numbers results in a positive number. \nExample: Using 4-bit 2's complement (range -8 to +7):\nAdding `0101` (+5) and `0100` (+4) gives `1001`. The expected result is +9. However, `1001` in 4-bit 2's complement represents -7. Since two positive numbers yielded a negative result, and +9 is outside the representable range, overflow has occurred. [cite: 36, 37]",
                markingScheme: [
                    { pointText: "Correctly stated that adding two positives can yield a negative (or two negatives yield positive) as an overflow condition.", marks: 1 },
                    { pointText: "Provided a valid example of adding two 4-bit positive numbers (e.g., +5 and +4).", marks: 1 },
                    { pointText: "Correctly showed the binary result of the example and identified it as an overflow because it's outside the valid range or has the wrong sign.", marks: 1 }
                ]
            },
            {
                type: "short-answer",
                text: "Describe the 'repeated division by 2' method to convert a decimal number to binary. What is done with the remainders? [cite: 14]",
                marksAwardable: 3,
                modelAnswer: "To convert a decimal number to binary using the 'repeated division by 2' method: \n1. Divide the decimal number by 2. \n2. Record the remainder (which will be 0 or 1). \n3. Take the quotient from the division and repeat steps 1 and 2 until the quotient becomes 0. \nThe binary representation is formed by reading the recorded remainders in reverse order of their calculation (the last remainder is the Most Significant Bit (MSB), and the first remainder is the Least Significant Bit (LSB)). [cite: 14]",
                markingScheme: [
                    { pointText: "Mentioned repeatedly dividing the decimal number by 2.", marks: 1 },
                    { pointText: "Stated that the remainder of each division is recorded.", marks: 1 },
                    { pointText: "Correctly explained that the binary number is formed by reading these remainders in reverse order.", marks: 1 }
                ]
            },
            {
                type: "short-answer",
                text: "What is sign extension in the context of signed binary numbers, and why is it important? Provide a simple example. [cite: 41]",
                marksAwardable: 3,
                modelAnswer: "Sign extension is the process of increasing the number of bits used to represent a signed binary number while preserving its sign and value. It's important when moving a number to a register or memory location that uses more bits, ensuring arithmetic operations remain correct. \nTo extend a signed number, you replicate its most significant bit (the sign bit) into the new higher-order bit positions. \nExample: Extending a 4-bit positive number `0101` (+5) to 8 bits becomes `00000101`. Extending a 4-bit negative number `1110` (-2 in 2's complement) to 8 bits becomes `11111110`. [cite: 41]",
                markingScheme: [
                    { pointText: "Correctly defined sign extension as increasing bits while preserving sign and value.", marks: 1 },
                    { pointText: "Explained its importance (e.g., for operations with different bit lengths).", marks: 1 },
                    { pointText: "Provided a correct example of sign extension for both a positive and a negative number (or one clear example showing the MSB replication).", marks: 1 }
                ]
            },
            // --- New Short Answers (Outside slides) ---
            {
                type: "short-answer",
                text: "Explain the difference between a 'bit' and a 'byte'. How many bits are in a byte?",
                marksAwardable: 2,
                modelAnswer: "A 'bit' is the smallest unit of digital information, representing either a 0 or a 1. A 'byte' is a unit of digital information typically consisting of 8 bits. It's the smallest addressable unit of memory in most computer architectures. Therefore, there are 8 bits in a byte.",
                markingScheme: [
                    { pointText: "Correctly defined 'bit' as the smallest unit (0 or 1).", marks: 1 },
                    { pointText: "Correctly defined 'byte' as a group of bits and stated that there are 8 bits in a byte.", marks: 1 }
                ]
            },
            {
                type: "short-answer",
                text: "What is the purpose of a 'truth table' in digital logic?",
                marksAwardable: 2,
                modelAnswer: "A truth table is a mathematical table used in logic (especially Boolean algebra and digital electronics) to compute the functional values of logical expressions on all their possible input combinations. It systematically lists all possible input states for a logic gate or circuit and the corresponding output state for each combination, making it easy to analyze and verify logic circuits.",
                markingScheme: [
                    { pointText: "Stated that a truth table lists all possible input combinations.", marks: 1 },
                    { pointText: "Explained that it shows the corresponding output for each input combination, used for analyzing or verifying logic.", marks: 1 }
                ]
            },
            {
                type: "short-answer",
                text: "Briefly describe what 'ASCII' is and its primary limitation.",
                marksAwardable: 2,
                modelAnswer: "ASCII (American Standard Code for Information Interchange) is a character encoding standard for electronic communication. ASCII codes represent text in computers, telecommunications equipment, and other devices. Its primary limitation is that it only supports 128 characters (or 256 in extended ASCII), which is insufficient for representing characters from many non-English languages and symbols, leading to the development of Unicode.",
                markingScheme: [
                    { pointText: "Correctly identified ASCII as a character encoding standard.", marks: 1 },
                    { pointText: "Correctly stated its primary limitation (e.g., limited character set, insufficient for global languages).", marks: 1 }
                ]
            }
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let gameHistory = []; 
        let availableQuestions = [...questions]; 

        const gameContainer = document.getElementById('game-container');
        const reviewContainer = document.getElementById('review-container');
        
        const questionTextElement = document.getElementById('question-text');
        const questionMarksInfoElement = document.getElementById('question-marks-info');
        const mcqOptionsElement = document.getElementById('mcq-options');
        const answerInputElement = document.getElementById('answer-input');
        const shortAnswerInputElement = document.getElementById('short-answer-input');
        
        const markingSchemeContainer = document.getElementById('marking-scheme-container');
        const markingSchemeOptionsElement = document.getElementById('marking-scheme-options');

        const submitButton = document.getElementById('submit-button');
        const confirmAssessmentButton = document.getElementById('confirm-assessment-button');
        const nextButton = document.getElementById('next-button');
        
        const feedbackElement = document.getElementById('feedback-area');
        const modelAnswerContainer = document.getElementById('model-answer-container');
        const modelAnswerTextElement = document.getElementById('model-answer-text');
        
        const currentScoreElement = document.getElementById('current-score');
        const finalScoreReviewElement = document.getElementById('final-score-review');
        const questionsAnsweredReviewElement = document.getElementById('questions-answered-review');
        const questionsWrongReviewElement = document.getElementById('questions-wrong-review');

        const reviewTableBodyElement = document.getElementById('review-table-body');
        const playAgainButton = document.getElementById('play-again-button');
        const backToStartButton = document.getElementById('back-to-start-button');

        const tabAllButton = document.getElementById('tab-all');
        const tabCorrectButton = document.getElementById('tab-correct');
        const tabWrongButton = document.getElementById('tab-wrong');


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getQuestionMarksInfo(question) {
            if (question.type === "mcq" || question.type === "calculation") {
                return "Correct: +1 point, Incorrect: -2 points";
            } else if (question.type === "short-answer") {
                return `Self-assess. Max ${question.marksAwardable} point(s) based on scheme.`;
            }
            return "";
        }

        function loadQuestion() {
            if (availableQuestions.length === 0 && score < TARGET_SCORE) {
                 endGame("No more questions available, but target not reached!");
                 return;
            }
             if (availableQuestions.length === 0 && score >= TARGET_SCORE) {
                 endGame("Target score reached and no more questions!");
                 return;
            }


            currentQuestionIndex = Math.floor(Math.random() * availableQuestions.length);
            const question = availableQuestions[currentQuestionIndex];
            
            questionTextElement.innerHTML = question.text
                                            .replace(/`([^`]+)`/g, '<code>$1</code>')
                                            .replace(/\[cite: ([^\]]+)]/g, '<small class="citation">[Source: Slide $1]</small>');
            questionMarksInfoElement.textContent = getQuestionMarksInfo(question);
            
            mcqOptionsElement.innerHTML = '';
            answerInputElement.style.display = 'none';
            shortAnswerInputElement.style.display = 'none';
            mcqOptionsElement.style.display = 'none';
            markingSchemeContainer.style.display = 'none';
            markingSchemeOptionsElement.innerHTML = '';
            modelAnswerContainer.style.display = 'none';
            feedbackElement.innerHTML = '';
            feedbackElement.className = ''; 

            submitButton.style.display = 'none';
            confirmAssessmentButton.style.display = 'none';
            nextButton.style.display = 'none';

            if (question.type === "mcq") {
                mcqOptionsElement.style.display = 'block';
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.onclick = () => processAnswer(option.correct, button);
                    mcqOptionsElement.appendChild(button);
                });
            } else if (question.type === "calculation") {
                answerInputElement.style.display = 'block';
                answerInputElement.value = '';
                submitButton.style.display = 'inline-block';
                answerInputElement.focus();
            } else if (question.type === "short-answer") {
                shortAnswerInputElement.style.display = 'block';
                shortAnswerInputElement.value = '';
                shortAnswerInputElement.disabled = false; // Ensure it's enabled
                submitButton.style.display = 'inline-block';
                shortAnswerInputElement.focus();
            }
            updateScoreDisplay();
        }

        function processAnswer(userChoiceOrValue, selectedButton = null) {
            const question = availableQuestions[currentQuestionIndex];
            let pointsAwarded = 0;
            let isCorrect = false;
            let userAnswerText = "";

            if (question.type === "mcq") {
                Array.from(mcqOptionsElement.children).forEach(btn => btn.disabled = true);
                userAnswerText = selectedButton.textContent;
            }

            if (question.type === "mcq" || question.type === "calculation") {
                if (question.type === "calculation") {
                    userAnswerText = answerInputElement.value.trim();
                    isCorrect = (userAnswerText.toLowerCase() === question.answer.toLowerCase());
                } else { 
                    isCorrect = userChoiceOrValue;
                    if (selectedButton) {
                        selectedButton.classList.add(isCorrect ? 'correct-selection' : 'incorrect-selection');
                        if(!isCorrect) {
                            const correctOptText = question.options.find(opt => opt.correct).text;
                            Array.from(mcqOptionsElement.children).forEach(btn => {
                                if(btn.textContent === correctOptText) {
                                    btn.classList.add('correct-selection');
                                }
                            });
                        }
                    }
                }

                pointsAwarded = isCorrect ? 1 : -2;
                score += pointsAwarded;
                feedbackElement.textContent = isCorrect ? `Correct! You earned ${pointsAwarded > 0 ? '+' : ''}${pointsAwarded} point(s).` : `Incorrect. You received ${pointsAwarded} points.`;
                feedbackElement.className = isCorrect ? 'correct-feedback' : 'incorrect-feedback';
                
                modelAnswerTextElement.innerHTML = question.explanation
                                                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                                                    .replace(/\[cite: ([^\]]+)]/g, '<small class="citation">[Source: Slide $1]</small>');
                modelAnswerContainer.style.display = 'block';
                
                gameHistory.push({
                    questionText: question.text,
                    questionType: question.type,
                    userAnswerText: userAnswerText,
                    correctAnswerText: question.type === "mcq" ? question.options.find(o => o.correct).text : question.answer,
                    scoreAwarded: pointsAwarded,
                    isCorrect: isCorrect, // Crucial for filtering
                    explanation: question.explanation
                });
                
                submitButton.style.display = 'none';
                nextButton.style.display = 'inline-block';

            } else if (question.type === "short-answer") {
                userAnswerText = shortAnswerInputElement.value.trim();
                shortAnswerInputElement.disabled = true;
                submitButton.style.display = 'none';

                feedbackElement.textContent = "Your answer submitted. Now, please self-assess using the marking scheme below.";
                feedbackElement.className = 'info-feedback';
                
                modelAnswerTextElement.innerHTML = question.modelAnswer
                                                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                                                    .replace(/\[cite: ([^\]]+)]/g, '<small class="citation">[Source: Slide $1]</small>');
                modelAnswerContainer.style.display = 'block';
                
                markingSchemeContainer.style.display = 'block';
                question.markingScheme.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'marking-scheme-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `scheme-item-${index}`;
                    checkbox.value = item.marks;
                    const label = document.createElement('label');
                    label.htmlFor = `scheme-item-${index}`;
                    label.textContent = ` ${item.pointText} (+${item.marks} point(s))`;
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    markingSchemeOptionsElement.appendChild(div);
                });
                confirmAssessmentButton.style.display = 'inline-block';
            }
            
            updateScoreDisplay();
            // Remove the answered question from the available pool immediately after processing
            if (availableQuestions.length > 0 && currentQuestionIndex < availableQuestions.length) {
                 availableQuestions.splice(currentQuestionIndex, 1);
            }

            if (score >= TARGET_SCORE && (question.type === "mcq" || question.type === "calculation")) {
                // If target is met by MCQ/Calc, and no more questions, end. Otherwise, next button will handle.
                 if (availableQuestions.length === 0) {
                    endGame("Target score reached and no more questions!");
                } else {
                    // Next button is already visible, user will click it.
                }
            } else if (availableQuestions.length === 0 && (question.type === "mcq" || question.type === "calculation")) {
                 endGame("All questions answered!");
            }
        }
        
        confirmAssessmentButton.onclick = () => {
            // Find the question from the main `questions` array based on the text currently displayed
            const currentQuestionTextFromDOM = document.getElementById('question-text').innerHTML.split('<small class="citation">')[0].trim();
            const originalQuestion = questions.find(q => q.text.split('[cite:')[0].trim() === currentQuestionTextFromDOM.split('[cite:')[0].trim() && q.type === "short-answer");

            if (!originalQuestion) {
                console.error("Could not find the original short answer question for assessment.");
                // Allow user to move on if question cannot be found for some reason
                nextButton.style.display = 'inline-block'; 
                confirmAssessmentButton.style.display = 'none';
                markingSchemeContainer.style.display = 'none';
                return;
            }
            processShortAnswerAssessment(originalQuestion);
        };

        function processShortAnswerAssessment(questionToAssess) {
            let pointsFromAssessment = 0;
            let userAssessmentDetails = [];

            questionToAssess.markingScheme.forEach((item, index) => {
                const checkbox = document.getElementById(`scheme-item-${index}`);
                const gotIt = checkbox.checked;
                if (gotIt) {
                    pointsFromAssessment += item.marks;
                }
                userAssessmentDetails.push({ pointText: item.pointText, marks: item.marks, awarded: gotIt });
            });

            score += pointsFromAssessment;
            feedbackElement.textContent = `Self-assessment complete. You awarded yourself ${pointsFromAssessment} point(s) for this question.`;
            feedbackElement.className = pointsFromAssessment > 0 ? 'correct-feedback' : 'info-feedback';

            gameHistory.push({
                questionText: questionToAssess.text,
                questionType: questionToAssess.type,
                userAnswerText: shortAnswerInputElement.value.trim(),
                correctAnswerText: questionToAssess.modelAnswer,
                markingScheme: questionToAssess.markingScheme,
                userAssessmentDetails: userAssessmentDetails,
                scoreAwarded: pointsFromAssessment,
                isCorrect: pointsFromAssessment > 0 // For filtering in review
            });
            
            shortAnswerInputElement.disabled = false; 
            markingSchemeContainer.style.display = 'none';
            markingSchemeOptionsElement.innerHTML = '';
            confirmAssessmentButton.style.display = 'none';
            nextButton.style.display = 'inline-block';
            
            updateScoreDisplay();
            if (score >= TARGET_SCORE) {
                 if (availableQuestions.length === 0) {
                    endGame("Target score reached and no more questions!");
                } else {
                    // Next button is already visible.
                }
            } else if (availableQuestions.length === 0) {
                 endGame("All questions answered!");
            }
        }


        submitButton.onclick = () => {
            const question = availableQuestions[currentQuestionIndex]; // This might be undefined if list is empty
            if (!question) { // Should not happen if loadQuestion has checks
                if(availableQuestions.length === 0) endGame("All questions answered!");
                return;
            }
             if (question.type === "calculation") {
                processAnswer(answerInputElement.value.trim());
            } else if (question.type === "short-answer") {
                if (shortAnswerInputElement.value.trim() === "") {
                    feedbackElement.textContent = "Please provide an answer before submitting.";
                    feedbackElement.className = 'incorrect-feedback';
                    return;
                }
                processAnswer(shortAnswerInputElement.value.trim());
            }
        };

        nextButton.onclick = () => {
            // Question was already removed in processAnswer or processShortAnswerAssessment
            if (score >= TARGET_SCORE) { 
                endGame("Target score reached!");
            } else if (availableQuestions.length === 0) {
                endGame("All questions answered!");
            }
            else {
                loadQuestion();
            }
        };
        
        function updateScoreDisplay() {
            currentScoreElement.textContent = `Current Score: ${score}`;
            currentScoreElement.className = score < 0 ? 'negative' : '';
        }

        function endGame(message) {
            gameContainer.style.display = 'none';
            reviewContainer.style.display = 'block';
            
            const questionsAnswered = gameHistory.length;
            const questionsWrong = gameHistory.filter(item => !item.isCorrect).length;

            finalScoreReviewElement.textContent = `${message} Final Score: ${score} / ${TARGET_SCORE}`;
            questionsAnsweredReviewElement.textContent = `Questions Answered: ${questionsAnswered}`;
            questionsWrongReviewElement.textContent = `Questions Incorrect/Points Not Awarded (Self-Assessed): ${questionsWrong}`;
            
            displayReviewTable('all'); // Default to show all questions
            setActiveTab(tabAllButton);
        }

        function displayReviewTable(filterType) {
            reviewTableBodyElement.innerHTML = ''; // Clear previous review
            let filteredHistory = gameHistory;

            if (filterType === 'correct') {
                filteredHistory = gameHistory.filter(item => item.isCorrect);
            } else if (filterType === 'wrong') {
                filteredHistory = gameHistory.filter(item => !item.isCorrect);
            }

            filteredHistory.forEach((item, index) => {
                const row = reviewTableBodyElement.insertRow();
                row.insertCell().textContent = index + 1; // Display running index for the filtered view
                
                const qCell = row.insertCell();
                qCell.innerHTML = `<div class="review-question-text">${item.questionText.replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\[cite: ([^\]]+)]/g, '<small class="citation">[Source: Slide $1]</small>')}</div> <small>(${item.questionType})</small>`;

                const userAnsCell = row.insertCell();
                userAnsCell.innerHTML = `<div class="review-user-answer">${item.userAnswerText.replace(/\n/g, '<br>')}</div>`;

                const correctAnsCell = row.insertCell();
                if (item.questionType === "short-answer") {
                    let schemeHTML = `<strong>Model:</strong> ${item.correctAnswerText.replace(/\n/g, '<br>')}<br><strong>Your Assessment:</strong><ul>`;
                    item.userAssessmentDetails.forEach(detail => {
                        schemeHTML += `<li>${detail.pointText} (${detail.awarded ? `+${detail.marks}` : '+0'} pts)</li>`;
                    });
                    schemeHTML += "</ul>";
                    correctAnsCell.innerHTML = schemeHTML;
                } else {
                    correctAnsCell.innerHTML = `<div class="review-correct-answer">${item.correctAnswerText}</div>`;
                    if(item.explanation) correctAnsCell.innerHTML += `<br><small><em>Explanation: ${item.explanation.replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\[cite: ([^\]]+)]/g, '<small class="citation">[Source: Slide $1]</small>')}</em></small>`;
                }
                
                const scoreCell = row.insertCell();
                scoreCell.innerHTML = `<div class="review-score">${item.scoreAwarded > 0 ? '+' : ''}${item.scoreAwarded}</div>`;
            });
        }

        function setActiveTab(activeButton) {
            [tabAllButton, tabCorrectButton, tabWrongButton].forEach(button => {
                button.classList.remove('active');
            });
            activeButton.classList.add('active');
        }
        
        tabAllButton.onclick = () => { displayReviewTable('all'); setActiveTab(tabAllButton); };
        tabCorrectButton.onclick = () => { displayReviewTable('correct'); setActiveTab(tabCorrectButton); };
        tabWrongButton.onclick = () => { displayReviewTable('wrong'); setActiveTab(tabWrongButton); };

        playAgainButton.onclick = () => {
            score = 0;
            gameHistory = [];
            availableQuestions = [...questions]; 
            shuffleArray(availableQuestions); 
            
            reviewContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            
            updateScoreDisplay();
            loadQuestion();
        };

        backToStartButton.onclick = () => {
            // For a single page app, "Back to Home" is effectively "Play Again" or reload
            playAgainButton.onclick(); // Re-use play again logic to reset
            // Alternatively, window.location.reload(); if a full reset is desired
        };

        // Start the game
        shuffleArray(availableQuestions);
        loadQuestion();
    </script>
</body>
</html>
